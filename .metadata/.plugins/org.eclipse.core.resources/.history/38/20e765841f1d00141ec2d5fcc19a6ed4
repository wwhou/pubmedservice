package patent;

import java.io.BufferedReader;
import java.io.File;
import java.io.IOException;
import java.io.InputStream;
import java.io.InputStreamReader;
import java.io.OutputStreamWriter;
import java.net.HttpURLConnection;
import java.net.MalformedURLException;
import java.net.URL;
import java.util.ArrayList;
import java.util.List;
import java.util.Map;
import java.util.Map.Entry;
import java.util.concurrent.ExecutionException;
import java.util.concurrent.Future;

import org.json.JSONArray;
import org.json.JSONException;
import org.json.JSONObject;

import util.FileExport;

/*
 From Ben Warren
 $(curl http://www.lens.org/cujo/search --header 'Content-Type:application/json' --data '{"query":"rice"}') | python -mjson.tool
 */

/*
 Call HTML from www.lens.org
 receive list of patents and then extract. Chase each patent for full front-page details
 Generate graph.
 */

public class LensCujoConnection {
    
    /*Build connection to CUJO, then download a list of patents.
     */
    int numResults;
    String query;
    String flags;
    String[] commands;
    //String charset = "UTF-8";
    //Graph patentGraph;
   List<String> docDB_keys;
    
   // HashSet<String> docDB_keys;
    //boolean validGraph;
    boolean valid;
    
    
    int MAX_NUM_PATENTS = 200;
    String cmd_base = "curl http://www.lens.org/cujo/search --header 'Content-Type:application/json'";
    String sortField;
    String url="http://www.lens.org/cujo/search";
    URL obj;
    HttpURLConnection conn;
    public LensCujoConnection(int numResults, String query, String sortField){
        this.numResults = numResults;
        this.sortField=sortField;
       // this.query =  " --data '{\"query\" :\"" + query + "\"";
        this.query="{\"query\" :\"" + query + "\"";
       
        try {
			obj=new URL(url);
			
		} catch (MalformedURLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
        //this.validGraph=false;
        this.valid = false;
        //patentGraph = new Graph();
        
        
        //        String cmd = " --data '{\"query\":\"rice\"";
        //        String cmd = " --data '{\"query\" :\"inventor: Leif Hanlen\"";
        //       String cmd = " --data '{\"query\" :\"docdb: US_B1_6511697\"";
        //  String cmd =  "--data '{\"query\":\"inventor: Jefferson Richard~2\"";
        //        String flags = ", \"facet\": \"false\", \"pageSize\": \"50\"}'";
        
        /* http://www.lens.org/textserver/frontpage.json?patent=US_B1_6511697 */
        
        
        
        this.flags = ", \"facet\": \"false\", \"pageSize\": \""+this.numResults+"\"}'";
        
        this.docDB_keys = new ArrayList<String>();
        //this.jsonVal="";
        
        //makePatentGraph();
    }
    
    public LensCujoConnection(String fullcommand){
        this.query = fullcommand;
        
        try {
			obj=new URL(url);
			
		} catch (MalformedURLException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
        this.docDB_keys = new ArrayList<String>();
        
    }
    
    public boolean connect(){
        boolean success = false;
        
        try {
			conn=(HttpURLConnection) obj.openConnection();
			conn.setRequestProperty("Content-Type", "application/json");
			conn.setDoOutput(true);
			conn.setRequestMethod("POST");
		String data =  query+ ", \"facet\": \"false\",\"sortField\": \""+this.sortField+"\",\"pageSize\": \""+this.numResults+"\",\"language\": \"en\"}'";
		//System.out.println(data);
		OutputStreamWriter out = new OutputStreamWriter(conn.getOutputStream());
	    out.write(data);
	    out.close();
	    
		   //System.out.print(sb.toString());
	    success=parseJSON(conn.getInputStream());
	    this.valid = true;
		} catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
			return false;
		}
        return success;
    }
    
    private void addKey(String key) {
        // System.out.println(key);
        this.docDB_keys.add(key);
    }
    
    
    private boolean parseJSON(InputStream instream){
        boolean success = false;
        try{
        	StringBuilder sb=new StringBuilder();
    	    BufferedReader br=new BufferedReader(new InputStreamReader(conn.getInputStream()));
    		   String line;
    		   while ((line = br.readLine()) != null) {
    				sb.append(line+"\n");
    			}
    		  // System.out.println(sb.toString());
            JSONObject jsonObject = new JSONObject(sb.toString());

            JSONArray jsonArrayResults = jsonObject.getJSONArray("results");
            
            for (int i=0; i<jsonArrayResults.length(); i++){
                JSONObject _temp_jsonObject = jsonArrayResults.getJSONObject(i);
                //System.out.println(_temp_jsonObject.getString("docdbKey"));
                String key=_temp_jsonObject.getString("docdbKey");              
                this.docDB_keys.add(key);
            }

            success = true;
            
        }catch (JSONException e) {
            System.err.println(e.getMessage());
            return false;
        } catch (IOException e) {
			// TODO Auto-generated catch block
			e.printStackTrace();
		}
        
        return success;
    }
 
    public List<String> getKeys() throws NullPointerException{
        if (this.valid)
            return this.docDB_keys;
        
        throw new NullPointerException("LensCujoConnection: No keys");
    }
    
    public static void main(String[] args) throws PatentException {
    	
    	LensCujoConnection lb=new LensCujoConnection(55, "NICTA", "pub_date");
    	lb.connect();
    	List<String> docKeys=lb.getKeys();
    	int i=0;
    	
    	MultithreadsJSONTextConnection multiJSON=new MultithreadsJSONTextConnection(docKeys);
//    	ArrayList<Future<String>> results=multiJSON.getXMLList();
//    	for(Future<String> result:results){
//    		try {
//				System.out.println(result.get().length());
//			} catch (InterruptedException e) {
//				// TODO Auto-generated catch block
//				e.printStackTrace();
//			} catch (ExecutionException e) {
//				// TODO Auto-generated catch block
//				e.printStackTrace();
//			}
//    	}
   // 	System.out.print(results.size());
    	
    }
}